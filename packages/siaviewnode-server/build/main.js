require("/home/lightsky/skynet-webportal/node_modules/source-map-support/register.js"),module.exports=function(e){var t={};function r(n){if(t[n])return t[n].exports;var o=t[n]={i:n,l:!1,exports:{}};return e[n].call(o.exports,o,o.exports,r),o.l=!0,o.exports}return r.m=e,r.c=t,r.d=function(e,t,n){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)r.d(n,o,function(t){return e[t]}.bind(null,o));return n},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="/",r(r.s=0)}([function(e,t,r){e.exports=r(1)},function(e,t,r){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const o=n(r(2)),s=n(r(3)),i=n(r(4)),a=n(r(5)),l=n(r(6)),u=n(r(7)),p=n(r(8)),f=n(r(9)),d=r(10),c=n(r(11)),h=n(r(12)),g=n(r(13)),m=1048576e3,y=o.default.create({baseURL:"http://localhost:9980",headers:{"User-Agent":"Sia-Agent","Access-Control-Allow-Origin":"*"},auth:{username:"",password:p.default.readFileSync(d.homedir().concat("/.sia/apipassword"),"utf8").trim()}}),x=c.default.path(["files","file"]),b=c.default.prop("name");class _{constructor(e){this.logger=e,this.boot()}boot(){this.app=i.default(),this.logger.info("Configuring middleware..."),this.configureMiddleware(),this.logger.info("Configuring routes..."),this.configureRoutes(),this.logger.info("Booting server...");const e=parseInt(process.env.PORT,10)||3e3;this.app.listen(e,()=>{this.logger.info(`Listening on port ${e}`)}),this.logger.info("Verifying connection to siad..."),this.verifyConnection().then(e=>{e&&this.logger.info(`siad reachable, version ${e}`)})}configureMiddleware(){this.app.use(u.default());const e={stream:{write:e=>{this.logger.info(e)}}};this.app.use(f.default("combined",e)),this.app.use(s.default()),this.app.use(a.default({limits:{fileSize:m}}))}configureRoutes(){this.app.post("/siafile",this.handleSiafilePOST.bind(this)),this.app.post("/skyfile",this.handleSkyfilePOST.bind(this)),this.app.get("/skylink/:hash",l.default("http://127.0.0.1:9980/skynet/skylink/",{proxyReqOptDecorator:(e,t)=>(e.headers["User-Agent"]="Sia-Agent",e),proxyReqPathResolver:e=>{const{hash:t}=e.params;return e.query&&e.query.attachment?`/skynet/skylink/${t}?attachment=true`:`/skynet/skylink/${t}`}})),this.app.get("/stats",this.handleStatsGET.bind(this))}async handleStatsGET(e,t){const r={"p80-1":40,"p95-1":44,"p99-1":48,"p80-24":42,"p95-24":44,"p99-24":46,"p80-168":41,"p95-168":45,"p99-168":49},n={1:22,24:438,168:2389},o={ttfb:r,download_small:r,download_throughput:r,download_total:n,upload_small:r,upload_throughput:r,upload_total:n,money_spent:{1:22,24:438,168:2389,720:12045,2160:63900},total_files_pinned:143,total_files_served:n};return t.send(o)}async verifyConnection(){try{return(await y.get("/daemon/version")).data.version}catch(e){const{message:t}=e;return this.logger.error(t),null}}async handleSkyfilePOST(e,t){const r=x(e);r||t.status(400).send({error:"Missing file"});const n=h.default.generate();this.logger.info(`POST skyfile w/name ${r.name} and uid ${n}`);try{const{data:e}=await y.post(`/skynet/skyfile/${n}`,r.data,{maxContentLength:m,params:{filename:r.name}});return t.send(e)}catch(e){const{message:r}=e;return this.logger.error(r),t.status(500).send({error:e.message})}}async handleSiafilePOST(e,t){const r=x(e),n=c.default.path(["headers","Content-Length"])(e);this.logger.info(`POST siafile ${r.name} w/contentlength ${n}`);try{const{data:e,headers:n}=await y.post("/renter/stream",r.data,{responseType:"stream"}),o=c.default.compose(c.default.head,c.default.split(".sia")),s=c.default.compose(o,b)(r);return t.set("Content-Disposition",`attachment; filename="${s}"; filename*="${s}"`),t.set("Content-Length",n["Content-Length"]),e.pipe(t)}catch(e){const{message:r}=e;return this.logger.error(r),t.status(500).send({error:e.message})}}}t.Server=_,e.exports=new _(g.default).app},function(e,t){e.exports=require("axios")},function(e,t){e.exports=require("cors")},function(e,t){e.exports=require("express")},function(e,t){e.exports=require("express-fileupload")},function(e,t){e.exports=require("express-http-proxy")},function(e,t){e.exports=require("express-request-id")},function(e,t){e.exports=require("fs")},function(e,t){e.exports=require("morgan")},function(e,t){e.exports=require("os")},function(e,t){e.exports=require("ramda")},function(e,t){e.exports=require("shortid")},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=r(14),{combine:o,timestamp:s,prettyPrint:i}=n.format,a=n.createLogger({format:o(s(),i()),transports:[new n.transports.Console,new n.transports.File({filename:"./error.log",level:"error",maxsize:5242880,maxFiles:2}),new n.transports.File({filename:"./info.log",level:"info",maxsize:5242880,maxFiles:5})],exitOnError:!1});t.default=a},function(e,t){e.exports=require("winston")}]);
//# sourceMappingURL=main.map